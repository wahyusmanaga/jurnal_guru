<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Presensi Siswa & Jurnal Mengajar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md slide-up">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">JURNAL MENGAJAR GURU</h2>
                <p class="text-gray-600">Silakan login untuk melanjutkan</p>
            </div>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan username" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan password" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                    Masuk
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Dashboard Presensi</h1>
                        <p id="userInfo" class="text-sm text-gray-600"></p>
                    </div>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-200">
                        Keluar
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Menu -->
        <div id="mainMenu" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-6">
                <div onclick="showPage('manajemenSiswa')" class="bg-white rounded-xl shadow-lg p-6 cursor-pointer hover:shadow-xl transition duration-300 text-center">
                    <div class="text-4xl mb-4">üë•</div>
                    <h3 class="text-lg font-semibold text-gray-800">Manajemen Siswa</h3>
                    <p class="text-gray-600 text-sm mt-2">Kelola data siswa</p>
                </div>
                <div onclick="showPage('inputPresensi')" class="bg-white rounded-xl shadow-lg p-6 cursor-pointer hover:shadow-xl transition duration-300 text-center">
                    <div class="text-4xl mb-4">‚úÖ</div>
                    <h3 class="text-lg font-semibold text-gray-800">Input Presensi</h3>
                    <p class="text-gray-600 text-sm mt-2">Catat kehadiran siswa</p>
                </div>
                <div onclick="showPage('rekapPresensi')" class="bg-white rounded-xl shadow-lg p-6 cursor-pointer hover:shadow-xl transition duration-300 text-center">
                    <div class="text-4xl mb-4">üìä</div>
                    <h3 class="text-lg font-semibold text-gray-800">Rekap Presensi</h3>
                    <p class="text-gray-600 text-sm mt-2">Lihat rekap kehadiran</p>
                </div>
                <div onclick="showPage('rekapJurnal')" class="bg-white rounded-xl shadow-lg p-6 cursor-pointer hover:shadow-xl transition duration-300 text-center">
                    <div class="text-4xl mb-4">üìù</div>
                    <h3 class="text-lg font-semibold text-gray-800">Rekap Jurnal</h3>
                    <p class="text-gray-600 text-sm mt-2">Lihat jurnal mengajar</p>
                </div>
            </div>
        </div>

        <!-- Manajemen Siswa -->
        <div id="manajemenSiswa" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">üë• Manajemen Siswa</h2>
                <button onclick="showPage('mainMenu')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Kembali</button>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">Tambah Siswa Baru</h3>
                <form id="formTambahSiswa" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" id="namaSiswa" placeholder="Nama Siswa" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    <select id="kelasSiswa" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Pilih Kelas</option>
                        <option value="X-1">X-1</option>
                        <option value="X-2">X-2</option>
                        <option value="X-3">X-3</option>
                        <option value="X-4">X-4</option>
                        <option value="X-5">X-5</option>
                        <option value="X-6">X-6</option>
                        <option value="X-7">X-7</option>
                        <option value="X-8">X-8</option>
                        <option value="X-9">X-9</option>
                        <option value="XI-1">XI-1</option>
                        <option value="XI-2">XI-2</option>
                        <option value="XI-3">XI-3</option>
                        <option value="XI-4">XI-4</option>
                        <option value="XI-5">XI-5</option>
                        <option value="XI-6">XI-6</option>
                        <option value="XI-7">XI-7</option>
                        <option value="XI-8">XI-8</option>
                        <option value="XI-9">XI-9</option>
                        <option value="XII-1">XII-1</option>
                        <option value="XII-2">XII-2</option>
                        <option value="XII-3">XII-3</option>
                        <option value="XII-4">XII-4</option>
                        <option value="XII-5">XII-5</option>
                        <option value="XII-6">XII-6</option>
                        <option value="XII-7">XII-7</option>
                        <option value="XII-8">XII-8</option>
                        <option value="XII-9">XII-9</option>
                    </select>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Simpan</button>
                </form>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">Import dari CSV</h3>
                <div class="flex flex-col sm:flex-row gap-4 sm:items-center">
                    <input type="file" id="csvFile" accept=".csv" class="flex-1 px-4 py-2 border rounded-lg">
                    <button onclick="importCSV()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg w-full sm:w-auto">Import</button>
                </div>
                <p class="text-sm text-gray-600 mt-2">Format CSV: Nama,Kelas</p>
            </div>

           <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                    <h3 class="text-lg font-semibold">Daftar Siswa</h3>
                    <select id="filterKelasDaftar" onchange="loadDaftarSiswa()" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Semua Kelas</option>
                        <option value="X-1">X-1</option>
                        <option value="X-2">X-2</option>
                        <option value="X-3">X-3</option>
                        <option value="X-4">X-4</option>
                        <option value="X-5">X-5</option>
                        <option value="X-6">X-6</option>
                        <option value="X-7">X-7</option>
                        <option value="X-8">X-8</option>
                        <option value="X-9">X-9</option>
                        <option value="XI-1">XI-1</option>
                        <option value="XI-2">XI-2</option>
                        <option value="XI-3">XI-3</option>
                        <option value="XI-4">XI-4</option>
                        <option value="XI-5">XI-5</option>
                        <option value="XI-6">XI-6</option>
                        <option value="XI-7">XI-7</option>
                        <option value="XI-8">XI-8</option>
                        <option value="XI-9">XI-9</option>
                        <option value="XII-1">XII-1</option>
                        <option value="XII-2">XII-2</option>
                        <option value="XII-3">XII-3</option>
                        <option value="XII-4">XII-4</option>
                        <option value="XII-5">XII-5</option>
                        <option value="XII-6">XII-6</option>
                        <option value="XII-7">XII-7</option>
                        <option value="XII-8">XII-8</option>
                        <option value="XII-9">XII-9</option>
                    </select>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-2 text-left">No</th>
                                <th class="px-4 py-2 text-left">Nama</th>
                                <th class="px-4 py-2 text-left">Kelas</th>
                                <th class="px-4 py-2 text-left">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="daftarSiswa">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Input Presensi -->
        <div id="inputPresensi" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">‚úÖ Input Presensi</h2>
                <button onclick="showPage('mainMenu')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Kembali</button>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <div class="flex flex-col sm:flex-row gap-4 sm:items-center">
                        <select id="filterKelas" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Pilih Kelas</option>
                            <option value="X-1">X-1</option>
                            <option value="X-2">X-2</option>
                            <option value="X-3">X-3</option>
                            <option value="X-4">X-4</option>
                            <option value="X-5">X-5</option>
                            <option value="X-6">X-6</option>
                            <option value="X-7">X-7</option>
                            <option value="X-8">X-8</option>
                            <option value="X-9">X-9</option>
                            <option value="XI-1">XI-1</option>
                            <option value="XI-2">XI-2</option>
                            <option value="XI-3">XI-3</option>
                            <option value="XI-4">XI-4</option>
                            <option value="XI-5">XI-5</option>
                            <option value="XI-6">XI-6</option>
                            <option value="XI-7">XI-7</option>
                            <option value="XI-8">XI-8</option>
                            <option value="XI-9">XI-9</option>
                            <option value="XII-1">XII-1</option>
                            <option value="XII-2">XII-2</option>
                            <option value="XII-3">XII-3</option>
                            <option value="XII-4">XII-4</option>
                            <option value="XII-5">XII-5</option>
                            <option value="XII-6">XII-6</option>
                            <option value="XII-7">XII-7</option>
                            <option value="XII-8">XII-8</option>
                            <option value="XII-9">XII-9</option>
                        </select>
                        <input type="date" id="tanggalPresensi" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button onclick="loadPresensi()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg w-full sm:w-auto">Tampilkan</button>
                        <button onclick="setSemuaHadir()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg w-full sm:w-auto">Set Semua Hadir</button>
                        <button onclick="saveAllPresensi()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg w-full sm:w-auto">üíæ Simpan Presensi</button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-2 text-left">No</th>
                                <th class="px-4 py-2 text-left">Nama</th>
                                <th class="px-4 py-2 text-left">Kelas</th>
                                <th class="px-4 py-2 text-left">Status</th>
                            </tr>
                        </thead>
                        <tbody id="daftarPresensi">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Jurnal Mengajar</h3>
                <form id="formJurnal" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                        <select id="namaMapel" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih Mata Pelajaran</option>
                            <option value="Antropologi">Antropologi</option>
                            <option value="Bahasa Asing (Arab, Jepang, Mandarin, Korea, Jerman, Prancis, dll.)">Bahasa Asing (Arab, Jepang, Mandarin, Korea, Jerman, Prancis, dll.)</option>
                            <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                            <option value="Bahasa Indonesia Tingkat Lanjut">Bahasa Indonesia Tingkat Lanjut</option>
                            <option value="Bahasa Inggris">Bahasa Inggris</option>
                            <option value="Bahasa Inggris Tingkat Lanjut">Bahasa Inggris Tingkat Lanjut</option>
                            <option value="Biologi">Biologi</option>
                            <option value="Ekonomi">Ekonomi</option>
                            <option value="Fisika">Fisika</option>
                            <option value="Geografi">Geografi</option>
                            <option value="Informatika">Informatika</option>
                            <option value="Kimia">Kimia</option>
                            <option value="Matematika">Matematika</option>
                            <option value="Matematika Tingkat Lanjut">Matematika Tingkat Lanjut</option>
                            <option value="Pendidikan Agama Buddha dan Budi Pekerti">Pendidikan Agama Buddha dan Budi Pekerti</option>
                            <option value="Pendidikan Agama Hindu dan Budi Pekerti">Pendidikan Agama Hindu dan Budi Pekerti</option>
                            <option value="Pendidikan Agama Islam dan Budi Pekerti">Pendidikan Agama Islam dan Budi Pekerti</option>
                            <option value="Pendidikan Agama Katolik dan Budi Pekerti">Pendidikan Agama Katolik dan Budi Pekerti</option>
                            <option value="Pendidikan Agama Khonghucu dan Budi Pekerti">Pendidikan Agama Khonghucu dan Budi Pekerti</option>
                            <option value="Pendidikan Agama Kristen dan Budi Pekerti">Pendidikan Agama Kristen dan Budi Pekerti</option>
                            <option value="Pendidikan Agama dan Budi Pekerti">Pendidikan Agama dan Budi Pekerti</option>
                            <option value="Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)">Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)</option>
                            <option value="Pendidikan Pancasila">Pendidikan Pancasila</option>
                            <option value="Prakarya & Kewirausahaan">Prakarya & Kewirausahaan</option>
                            <option value="Seni dan Budaya (Musik, Rupa, Tari, Teater)">Seni dan Budaya (Musik, Rupa, Tari, Teater)</option>
                            <option value="Sosiologi">Sosiologi</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jam Awal</label>
                            <select id="jamAwal" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Pilih Jam Awal</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jam Akhir</label>
                            <select id="jamAkhir" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Pilih Jam Akhir</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Siswa Hadir</label>
                            <input type="number" id="jumlahHadir" class="w-full px-4 py-2 border rounded-lg bg-gray-100" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Siswa Tidak Hadir</label>
                            <input type="number" id="jumlahTidakHadir" class="w-full px-4 py-2 border rounded-lg bg-gray-100" readonly>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Siswa Tidak Hadir</label>
                        <textarea id="namaTidakHadir" class="w-full px-4 py-2 border rounded-lg bg-gray-100" rows="2" readonly></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kegiatan</label>
                        <textarea id="kegiatan" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" rows="2" required></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Materi</label>
                        <textarea id="materi" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" rows="2" required></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
                        <textarea id="keterangan" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" rows="2"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold">Simpan Jurnal</button>
                </form>
            </div>
        </div>

        <!-- Rekap Presensi -->
        <div id="rekapPresensi" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">üìä Rekap Presensi</h2>
                <button onclick="showPage('mainMenu')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Kembali</button>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <div class="flex flex-col sm:flex-row gap-4 sm:items-center">
                        <select id="filterKelasRekap" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Semua Kelas</option>
                            <option value="X-1">X-1</option>
                            <option value="X-2">X-2</option>
                            <option value="X-3">X-3</option>
                            <option value="X-4">X-4</option>
                            <option value="X-5">X-5</option>
                            <option value="X-6">X-6</option>
                            <option value="X-7">X-7</option>
                            <option value="X-8">X-8</option>
                            <option value="X-9">X-9</option>
                            <option value="XI-1">XI-1</option>
                            <option value="XI-2">XI-2</option>
                            <option value="XI-3">XI-3</option>
                            <option value="XI-4">XI-4</option>
                            <option value="XI-5">XI-5</option>
                            <option value="XI-6">XI-6</option>
                            <option value="XI-7">XI-7</option>
                            <option value="XI-8">XI-8</option>
                            <option value="XI-9">XI-9</option>
                            <option value="XII-1">XII-1</option>
                            <option value="XII-2">XII-2</option>
                            <option value="XII-3">XII-3</option>
                            <option value="XII-4">XII-4</option>
                            <option value="XII-5">XII-5</option>
                            <option value="XII-6">XII-6</option>
                            <option value="XII-7">XII-7</option>
                            <option value="XII-8">XII-8</option>
                            <option value="XII-9">XII-9</option>
                        </select>
                        <input type="date" id="filterTanggal" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button onclick="rekapHarian()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg w-full sm:w-auto">Rekap Harian</button>
                        <button onclick="rekapSemuaWaktu()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg w-full sm:w-auto">Rekap Semua Waktu</button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <div id="hasilRekap">
                    <p class="text-gray-500 text-center py-8">Pilih filter dan klik tombol rekap untuk melihat data</p>
                </div>
            </div>
        </div>

        <!-- Rekap Jurnal -->
        <div id="rekapJurnal" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">üìù Rekap Jurnal</h2>
                <button onclick="showPage('mainMenu')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Kembali</button>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <input type="date" id="filterTanggalJurnal" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <select id="filterKelasJurnal" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Semua Kelas</option>
                        <option value="X-1">X-1</option>
                        <option value="X-2">X-2</option>
                        <option value="X-3">X-3</option>
                        <option value="X-4">X-4</option>
                        <option value="X-5">X-5</option>
                        <option value="X-6">X-6</option>
                        <option value="X-7">X-7</option>
                        <option value="X-8">X-8</option>
                        <option value="X-9">X-9</option>
                        <option value="XI-1">XI-1</option>
                        <option value="XI-2">XI-2</option>
                        <option value="XI-3">XI-3</option>
                        <option value="XI-4">XI-4</option>
                        <option value="XI-5">XI-5</option>
                        <option value="XI-6">XI-6</option>
                        <option value="XI-7">XI-7</option>
                        <option value="XI-8">XI-8</option>
                        <option value="XI-9">XI-9</option>
                        <option value="XII-1">XII-1</option>
                        <option value="XII-2">XII-2</option>
                        <option value="XII-3">XII-3</option>
                        <option value="XII-4">XII-4</option>
                        <option value="XII-5">XII-5</option>
                        <option value="XII-6">XII-6</option>
                        <option value="XII-7">XII-7</option>
                        <option value="XII-8">XII-8</option>
                        <option value="XII-9">XII-9</option>
                    </select>
                    <select id="filterMapelJurnal" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Semua Mata Pelajaran</option>
                        <option value="Antropologi">Antropologi</option>
                        <option value="Bahasa Asing (Arab, Jepang, Mandarin, Korea, Jerman, Prancis, dll.)">Bahasa Asing (Arab, Jepang, Mandarin, Korea, Jerman, Prancis, dll.)</option>
                        <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                        <option value="Bahasa Indonesia Tingkat Lanjut">Bahasa Indonesia Tingkat Lanjut</option>
                        <option value="Bahasa Inggris">Bahasa Inggris</option>
                        <option value="Bahasa Inggris Tingkat Lanjut">Bahasa Inggris Tingkat Lanjut</option>
                        <option value="Biologi">Biologi</option>
                        <option value="Ekonomi">Ekonomi</option>
                        <option value="Fisika">Fisika</option>
                        <option value="Geografi">Geografi</option>
                        <option value="Informatika">Informatika</option>
                        <option value="Kimia">Kimia</option>
                        <option value="Matematika">Matematika</option>
                        <option value="Matematika Tingkat Lanjut">Matematika Tingkat Lanjut</option>
                        <option value="Pendidikan Agama Buddha dan Budi Pekerti">Pendidikan Agama Buddha dan Budi Pekerti</option>
                        <option value="Pendidikan Agama Hindu dan Budi Pekerti">Pendidikan Agama Hindu dan Budi Pekerti</option>
                        <option value="Pendidikan Agama Islam dan Budi Pekerti">Pendidikan Agama Islam dan Budi Pekerti</option>
                        <option value="Pendidikan Agama Katolik dan Budi Pekerti">Pendidikan Agama Katolik dan Budi Pekerti</option>
                        <option value="Pendidikan Agama Khonghucu dan Budi Pekerti">Pendidikan Agama Khonghucu dan Budi Pekerti</option>
                        <option value="Pendidikan Agama Kristen dan Budi Pekerti">Pendidikan Agama Kristen dan Budi Pekerti</option>
                        <option value="Pendidikan Agama dan Budi Pekerti">Pendidikan Agama dan Budi Pekerti</option>
                        <option value="Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)">Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)</option>
                        <option value="Pendidikan Pancasila">Pendidikan Pancasila</option>
                        <option value="Prakarya & Kewirausahaan">Prakarya & Kewirausahaan</option>
                        <option value="Seni dan Budaya (Musik, Rupa, Tari, Teater)">Seni dan Budaya (Musik, Rupa, Tari, Teater)</option>
                        <option value="Sosiologi">Sosiologi</option>
                    </select>
                    <button onclick="loadJurnal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Tampilkan</button>
                    <button onclick="downloadJurnalPDF()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">üìÑ Download PDF</button>
                </div>
            </div>

           <div class="bg-white rounded-xl shadow-lg p-6">
                <!-- Desktop Table -->
                <div class="hidden md:block overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-2 text-left">No</th>
                                <th class="px-4 py-2 text-left">Mata Pelajaran</th>
                                <th class="px-4 py-2 text-left">Kelas</th>
                                <th class="px-4 py-2 text-left">Tanggal</th>
                                <th class="px-4 py-2 text-left">Jam Awal</th>
                                <th class="px-4 py-2 text-left">Jam Akhir</th>
                                <th class="px-4 py-2 text-left">Hadir</th>
                                <th class="px-4 py-2 text-left">Tidak Hadir</th>
                                <th class="px-4 py-2 text-left">Nama Siswa Tidak Hadir</th>
                                <th class="px-4 py-2 text-left">Kegiatan</th>
                                <th class="px-4 py-2 text-left">Materi</th>
                                <th class="px-4 py-2 text-left">Keterangan</th>
                                <th class="px-4 py-2 text-left">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="daftarJurnal">
                        </tbody>
                    </table>
                </div>
                
                <!-- Mobile Cards -->
                <div class="md:hidden space-y-4" id="daftarJurnalMobile">
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Konfirmasi -->
    <div id="modalKonfirmasi" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">Konfirmasi</h3>
            <p id="pesanKonfirmasi" class="text-gray-600 mb-6"></p>
            <div class="flex gap-4">
                <button onclick="closeModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg">Batal</button>
                <button id="btnKonfirmasi" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg">Hapus</button>
            </div>
        </div>
    </div>

    <!-- Modal Edit Siswa -->
    <div id="modalEditSiswa" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">Edit Siswa</h3>
            <form id="formEditSiswa" class="space-y-4">
                <input type="hidden" id="editSiswaId">
                <input type="text" id="editNamaSiswa" placeholder="Nama Siswa" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                <select id="editKelasSiswa" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    <option value="">Pilih Kelas</option>
                    <option value="X-1">X-1</option>
                    <option value="X-2">X-2</option>
                    <option value="X-3">X-3</option>
                    <option value="X-4">X-4</option>
                    <option value="X-5">X-5</option>
                    <option value="X-6">X-6</option>
                    <option value="X-7">X-7</option>
                    <option value="X-8">X-8</option>
                    <option value="X-9">X-9</option>
                    <option value="XI-1">XI-1</option>
                    <option value="XI-2">XI-2</option>
                    <option value="XI-3">XI-3</option>
                    <option value="XI-4">XI-4</option>
                    <option value="XI-5">XI-5</option>
                    <option value="XI-6">XI-6</option>
                    <option value="XI-7">XI-7</option>
                    <option value="XI-8">XI-8</option>
                    <option value="XI-9">XI-9</option>
                    <option value="XII-1">XII-1</option>
                    <option value="XII-2">XII-2</option>
                    <option value="XII-3">XII-3</option>
                    <option value="XII-4">XII-4</option>
                    <option value="XII-5">XII-5</option>
                    <option value="XII-6">XII-6</option>
                    <option value="XII-7">XII-7</option>
                    <option value="XII-8">XII-8</option>
                    <option value="XII-9">XII-9</option>
                </select>
                <div class="flex gap-4">
                    <button type="button" onclick="closeModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg">Batal</button>
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Edit Jurnal -->
    <div id="modalEditJurnal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4">Edit Jurnal</h3>
            <form id="formEditJurnal" class="space-y-4">
                <input type="hidden" id="editJurnalId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                    <select id="editNamaMapel" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Pilih Mata Pelajaran</option>
                        <option value="Antropologi">Antropologi</option>
                        <option value="Bahasa Asing (Arab, Jepang, Mandarin, Korea, Jerman, Prancis, dll.)">Bahasa Asing (Arab, Jepang, Mandarin, Korea, Jerman, Prancis, dll.)</option>
                        <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                        <option value="Bahasa Indonesia Tingkat Lanjut">Bahasa Indonesia Tingkat Lanjut</option>
                        <option value="Bahasa Inggris">Bahasa Inggris</option>
                        <option value="Bahasa Inggris Tingkat Lanjut">Bahasa Inggris Tingkat Lanjut</option>
                        <option value="Biologi">Biologi</option>
                        <option value="Ekonomi">Ekonomi</option>
                        <option value="Fisika">Fisika</option>
                        <option value="Geografi">Geografi</option>
                        <option value="Informatika">Informatika</option>
                        <option value="Kimia">Kimia</option>
                        <option value="Matematika">Matematika</option>
                        <option value="Matematika Tingkat Lanjut">Matematika Tingkat Lanjut</option>
                        <option value="Pendidikan Agama Buddha dan Budi Pekerti">Pendidikan Agama Buddha dan Budi Pekerti</option>
                        <option value="Pendidikan Agama Hindu dan Budi Pekerti">Pendidikan Agama Hindu dan Budi Pekerti</option>
                        <option value="Pendidikan Agama Islam dan Budi Pekerti">Pendidikan Agama Islam dan Budi Pekerti</option>
                        <option value="Pendidikan Agama Katolik dan Budi Pekerti">Pendidikan Agama Katolik dan Budi Pekerti</option>
                        <option value="Pendidikan Agama Khonghucu dan Budi Pekerti">Pendidikan Agama Khonghucu dan Budi Pekerti</option>
                        <option value="Pendidikan Agama Kristen dan Budi Pekerti">Pendidikan Agama Kristen dan Budi Pekerti</option>
                        <option value="Pendidikan Agama dan Budi Pekerti">Pendidikan Agama dan Budi Pekerti</option>
                        <option value="Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)">Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)</option>
                        <option value="Pendidikan Pancasila">Pendidikan Pancasila</option>
                        <option value="Prakarya & Kewirausahaan">Prakarya & Kewirausahaan</option>
                        <option value="Seni dan Budaya (Musik, Rupa, Tari, Teater)">Seni dan Budaya (Musik, Rupa, Tari, Teater)</option>
                        <option value="Sosiologi">Sosiologi</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                    <select id="editKelasJurnal" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Pilih Kelas</option>
                        <option value="X-1">X-1</option>
                        <option value="X-2">X-2</option>
                        <option value="X-3">X-3</option>
                        <option value="X-4">X-4</option>
                        <option value="X-5">X-5</option>
                        <option value="X-6">X-6</option>
                        <option value="X-7">X-7</option>
                        <option value="X-8">X-8</option>
                        <option value="X-9">X-9</option>
                        <option value="XI-1">XI-1</option>
                        <option value="XI-2">XI-2</option>
                        <option value="XI-3">XI-3</option>
                        <option value="XI-4">XI-4</option>
                        <option value="XI-5">XI-5</option>
                        <option value="XI-6">XI-6</option>
                        <option value="XI-7">XI-7</option>
                        <option value="XI-8">XI-8</option>
                        <option value="XI-9">XI-9</option>
                        <option value="XII-1">XII-1</option>
                        <option value="XII-2">XII-2</option>
                        <option value="XII-3">XII-3</option>
                        <option value="XII-4">XII-4</option>
                        <option value="XII-5">XII-5</option>
                        <option value="XII-6">XII-6</option>
                        <option value="XII-7">XII-7</option>
                        <option value="XII-8">XII-8</option>
                        <option value="XII-9">XII-9</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jam Awal</label>
                        <select id="editJamAwal" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih Jam Awal</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jam Akhir</label>
                        <select id="editJamAkhir" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Pilih Jam Akhir</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Siswa Hadir</label>
                        <input type="number" id="editJumlahHadir" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Siswa Tidak Hadir</label>
                        <input type="number" id="editJumlahTidakHadir" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Siswa Tidak Hadir</label>
                    <textarea id="editNamaTidakHadir" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" rows="2" placeholder="Contoh: Ahmad (Sakit), Siti (Alpha)"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kegiatan</label>
                    <textarea id="editKegiatan" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" rows="2" required></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Materi</label>
                    <textarea id="editMateri" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" rows="2" required></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
                    <textarea id="editKeterangan" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" rows="2"></textarea>
                </div>
                <div class="flex gap-4">
                    <button type="button" onclick="closeModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg">Batal</button>
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const supabaseUrl = 'https://whyybcwrtbfndplvupvz.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndoeXliY3dydGJmbmRwbHZ1cHZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMzk1NzYsImV4cCI6MjA3MzkxNTU3Nn0.w1kgBPsBBioEPmzJ58qbeD0yv7yUPUvC0d7ulKBXa_Q';
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        // Data Storage
        let siswaData = [];
        let presensiData = [];
        let jurnalData = [];
        let currentUser = null;

        // Database Functions
        async function loadAllData() {
            try {
                // Load siswa data
                const { data: siswa, error: siswaError } = await supabaseClient
                    .from('siswa')
                    .select('*')
                    .order('nama');
                if (siswaError) throw siswaError;
                siswaData = siswa || [];

                // Load presensi data
                const { data: presensi, error: presensiError } = await supabaseClient
                    .from('presensi')
                    .select('*')
                    .order('tanggal', { ascending: false });
                if (presensiError) throw presensiError;
                presensiData = presensi || [];

                // Load jurnal data
                const { data: jurnal, error: jurnalError } = await supabaseClient
                    .from('jurnal')
                    .select('*')
                    .order('tanggal', { ascending: false });
                if (jurnalError) throw jurnalError;
                jurnalData = jurnal || [];

                console.log('Data loaded successfully from database');
            } catch (error) {
                console.error('Error loading data:', error);
                showAlert('Gagal memuat data dari server', 'error');
            }
        }

        async function authenticateUser(username, password) {
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .eq('is_active', true)
                    .single();
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        return null; // No matching user found
                    }
                    throw error;
                }
                
                return data;
            } catch (error) {
                console.error('Error authenticating user:', error);
                throw error;
            }
        }

        async function saveSiswa(siswa) {
            try {
                const { data, error } = await supabaseClient
                    .from('siswa')
                    .insert([siswa])
                    .select();
                if (error) throw error;
                return data[0];
            } catch (error) {
                console.error('Error saving siswa:', error);
                throw error;
            }
        }

        async function updateSiswa(id, siswa) {
            try {
                const { data, error } = await supabaseClient
                    .from('siswa')
                    .update(siswa)
                    .eq('id', id)
                    .select();
                if (error) throw error;
                return data[0];
            } catch (error) {
                console.error('Error updating siswa:', error);
                throw error;
            }
        }

        async function deleteSiswa(id) {
            try {
                const { error } = await supabaseClient
                    .from('siswa')
                    .delete()
                    .eq('id', id);
                if (error) throw error;
            } catch (error) {
                console.error('Error deleting siswa:', error);
                throw error;
            }
        }

        async function savePresensi(presensi) {
            try {
                const { data, error } = await supabaseClient
                    .from('presensi')
                    .upsert([presensi])
                    .select();
                if (error) throw error;
                return data[0];
            } catch (error) {
                console.error('Error saving presensi:', error);
                throw error;
            }
        }

        async function saveJurnal(jurnal) {
            try {
                const { data, error } = await supabaseClient
                    .from('jurnal')
                    .insert([jurnal])
                    .select();
                if (error) throw error;
                return data[0];
            } catch (error) {
                console.error('Error saving jurnal:', error);
                throw error;
            }
        }

        async function updateJurnal(id, jurnal) {
            try {
                const { data, error } = await supabaseClient
                    .from('jurnal')
                    .update(jurnal)
                    .eq('id', id)
                    .select();
                if (error) throw error;
                return data[0];
            } catch (error) {
                console.error('Error updating jurnal:', error);
                throw error;
            }
        }

        async function deleteJurnal(id) {
            try {
                const { error } = await supabaseClient
                    .from('jurnal')
                    .delete()
                    .eq('id', id);
                if (error) throw error;
            } catch (error) {
                console.error('Error deleting jurnal:', error);
                throw error;
            }
        }

        // Set tanggal hari ini dan load data
        document.addEventListener('DOMContentLoaded', async function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggalPresensi').value = today;
            document.getElementById('filterTanggal').value = today;
            document.getElementById('filterTanggalJurnal').value = today;
            
            // Check for existing session
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('userInfo').textContent = `Selamat datang, ${currentUser.nama_lengkap} (${currentUser.role})`;
                await loadAllData();
            } else {
                // Load data even if not logged in (for login validation)
                await loadAllData();
            }
        });

        // Login Function
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const user = await authenticateUser(username, password);
                
                if (user) {
                    currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    document.getElementById('userInfo').textContent = `Selamat datang, ${user.nama_lengkap} (${user.role})`;
                    
                    showAlert('Login berhasil!', 'success');
                    await loadAllData();
                } else {
                    showAlert('Username atau password salah!', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showAlert('Terjadi kesalahan saat login!', 'error');
            }
        });

        // Logout Function
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('userInfo').textContent = '';
        }

        // Show Page Function
        function showPage(pageId) {
            // Hide all pages
            const pages = ['mainMenu', 'manajemenSiswa', 'inputPresensi', 'rekapPresensi', 'rekapJurnal'];
            pages.forEach(page => {
                document.getElementById(page).classList.add('hidden');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.remove('hidden');
            document.getElementById(pageId).classList.add('fade-in');
            
            // Load data for specific pages
            if (pageId === 'manajemenSiswa') {
                loadDaftarSiswa();
            }
        }

        // Alert Function
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg text-white font-semibold slide-up ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // Manajemen Siswa Functions
        document.getElementById('formTambahSiswa').addEventListener('submit', async function(e) {
            e.preventDefault();
            const nama = document.getElementById('namaSiswa').value;
            const kelas = document.getElementById('kelasSiswa').value;
            
            try {
                const siswa = {
                    nama: nama,
                    kelas: kelas
                };
                
                const savedSiswa = await saveSiswa(siswa);
                siswaData.push(savedSiswa);
                
                showAlert('Data berhasil disimpan!', 'success');
                document.getElementById('formTambahSiswa').reset();
                loadDaftarSiswa();
            } catch (error) {
                showAlert('Gagal menyimpan data!', 'error');
            }
        });

        function loadDaftarSiswa() {
            const tbody = document.getElementById('daftarSiswa');
            tbody.innerHTML = '';
            
            const filterKelas = document.getElementById('filterKelasDaftar').value;
            let filteredSiswa = siswaData;
            
            if (filterKelas) {
                filteredSiswa = siswaData.filter(s => s.kelas === filterKelas);
            }
            
            filteredSiswa.forEach((siswa, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-2">${index + 1}</td>
                    <td class="px-4 py-2">${siswa.nama}</td>
                    <td class="px-4 py-2">${siswa.kelas}</td>
                    <td class="px-4 py-2">
                        <button onclick="editSiswa(${siswa.id})" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm mr-2">Edit</button>
                        <button onclick="hapusSiswa(${siswa.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">Hapus</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function editSiswa(id) {
            const siswa = siswaData.find(s => s.id === id);
            if (siswa) {
                document.getElementById('editSiswaId').value = siswa.id;
                document.getElementById('editNamaSiswa').value = siswa.nama;
                document.getElementById('editKelasSiswa').value = siswa.kelas;
                document.getElementById('modalEditSiswa').classList.remove('hidden');
            }
        }

        document.getElementById('formEditSiswa').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = parseInt(document.getElementById('editSiswaId').value);
            const nama = document.getElementById('editNamaSiswa').value;
            const kelas = document.getElementById('editKelasSiswa').value;
            
            try {
                const siswaUpdate = { nama, kelas };
                await updateSiswa(id, siswaUpdate);
                
                const index = siswaData.findIndex(s => s.id === id);
                if (index !== -1) {
                    siswaData[index].nama = nama;
                    siswaData[index].kelas = kelas;
                }
                
                showAlert('Data berhasil diperbarui!', 'success');
                closeModal();
                loadDaftarSiswa();
            } catch (error) {
                showAlert('Gagal memperbarui data!', 'error');
            }
        });

        function hapusSiswa(id) {
            showConfirmModal('Apakah Anda yakin ingin menghapus siswa ini?', async () => {
                try {
                    await deleteSiswa(id);
                    siswaData = siswaData.filter(s => s.id !== id);
                    showAlert('Data berhasil dihapus!', 'success');
                    loadDaftarSiswa();
                } catch (error) {
                    showAlert('Gagal menghapus data!', 'error');
                }
            });
        }

        async function importCSV() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('Pilih file CSV terlebih dahulu!', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                let imported = 0;
                
                try {
                    for (let i = 1; i < lines.length; i++) { // Skip header
                        const line = lines[i].trim();
                        if (line) {
                            const [nama, kelas] = line.split(',');
                            if (nama && kelas) {
                                const siswa = {
                                    nama: nama.trim(),
                                    kelas: kelas.trim()
                                };
                                const savedSiswa = await saveSiswa(siswa);
                                siswaData.push(savedSiswa);
                                imported++;
                            }
                        }
                    }
                    
                    showAlert(`${imported} siswa berhasil diimport!`, 'success');
                    loadDaftarSiswa();
                    fileInput.value = '';
                } catch (error) {
                    showAlert('Gagal mengimport data!', 'error');
                }
            };
            reader.readAsText(file);
        }

        // Input Presensi Functions
        function loadPresensi() {
            const kelas = document.getElementById('filterKelas').value;
            const tanggal = document.getElementById('tanggalPresensi').value;
            
            if (!kelas || !tanggal) {
                showAlert('Pilih kelas dan tanggal terlebih dahulu!', 'error');
                return;
            }
            
            const siswaKelas = siswaData.filter(s => s.kelas === kelas);
            const container = document.getElementById('daftarPresensi');
            container.innerHTML = '';
            
            siswaKelas.forEach((siswa, index) => {
                const existingPresensi = presensiData.find(p => 
                    p.siswa_id === siswa.id && p.tanggal === tanggal
                );
                
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-2">${index + 1}</td>
                    <td class="px-4 py-2 font-medium">${siswa.nama}</td>
                    <td class="px-4 py-2">${siswa.kelas}</td>
                    <td class="px-4 py-2">
                        <select class="px-3 py-1 border rounded focus:ring-2 focus:ring-blue-500" 
                                onchange="updatePresensi(${siswa.id}, '${tanggal}', this.value)">
                            <option value="Hadir" ${existingPresensi?.status === 'Hadir' ? 'selected' : ''}>Hadir</option>
                            <option value="Ijin" ${existingPresensi?.status === 'Ijin' ? 'selected' : ''}>Ijin</option>
                            <option value="Sakit" ${existingPresensi?.status === 'Sakit' ? 'selected' : ''}>Sakit</option>
                            <option value="Alpha" ${existingPresensi?.status === 'Alpha' || !existingPresensi ? 'selected' : ''}>Alpha</option>
                            <option value="Dispen" ${existingPresensi?.status === 'Dispen' ? 'selected' : ''}>Dispen</option>
                        </select>
                    </td>
                `;
                container.appendChild(row);
            });
            
            updateJurnalStats();
        }

        function updatePresensi(siswaId, tanggal, status) {
            // Update local data only, don't save to database yet
            const existingIndex = presensiData.findIndex(p => 
                p.siswa_id === siswaId && p.tanggal === tanggal
            );
            
            if (existingIndex !== -1) {
                presensiData[existingIndex].status = status;
            } else {
                presensiData.push({
                    siswa_id: siswaId,
                    tanggal: tanggal,
                    status: status
                });
            }
            
            updateJurnalStats();
        }

        async function saveAllPresensi() {
            const kelas = document.getElementById('filterKelas').value;
            const tanggal = document.getElementById('tanggalPresensi').value;
            
            if (!kelas || !tanggal) {
                showAlert('Pilih kelas dan tanggal terlebih dahulu!', 'error');
                return;
            }
            
            try {
                const siswaKelas = siswaData.filter(s => s.kelas === kelas);
                const presensiHariIni = presensiData.filter(p => p.tanggal === tanggal);
                
                for (const siswa of siswaKelas) {
                    const presensi = presensiHariIni.find(p => p.siswa_id === siswa.id);
                    if (presensi) {
                        await savePresensi(presensi);
                    }
                }
                
                showAlert('Semua presensi berhasil disimpan!', 'success');
            } catch (error) {
                showAlert('Gagal menyimpan presensi!', 'error');
            }
        }

        function setSemuaHadir() {
            const kelas = document.getElementById('filterKelas').value;
            const tanggal = document.getElementById('tanggalPresensi').value;
            
            if (!kelas || !tanggal) {
                showAlert('Pilih kelas dan tanggal terlebih dahulu!', 'error');
                return;
            }
            
            const siswaKelas = siswaData.filter(s => s.kelas === kelas);
            
            siswaKelas.forEach(siswa => {
                updatePresensi(siswa.id, tanggal, 'Hadir');
            });
            
            loadPresensi();
            showAlert('Semua siswa telah diset hadir!', 'success');
        }

        function updateJurnalStats() {
            const kelas = document.getElementById('filterKelas').value;
            const tanggal = document.getElementById('tanggalPresensi').value;
            
            if (!kelas || !tanggal) return;
            
            const siswaKelas = siswaData.filter(s => s.kelas === kelas);
            const presensiHariIni = presensiData.filter(p => p.tanggal === tanggal);
            
            let hadir = 0;
            let tidakHadir = 0;
            let namaTidakHadir = [];
            
            siswaKelas.forEach(siswa => {
                const presensi = presensiHariIni.find(p => p.siswa_id === siswa.id);
                if (presensi && presensi.status === 'Hadir') {
                    hadir++;
                } else {
                    tidakHadir++;
                    const status = presensi ? presensi.status : 'Alpha';
                    namaTidakHadir.push(`${siswa.nama} (${status})`);
                }
            });
            
            document.getElementById('jumlahHadir').value = hadir;
            document.getElementById('jumlahTidakHadir').value = tidakHadir;
            document.getElementById('namaTidakHadir').value = namaTidakHadir.join(', ');
        }



        // Jurnal Functions
        document.getElementById('formJurnal').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const jurnal = {
                    tanggal: document.getElementById('tanggalPresensi').value,
                    kelas: document.getElementById('filterKelas').value,
                    mapel: document.getElementById('namaMapel').value,
                    jam_awal: document.getElementById('jamAwal').value,
                    jam_akhir: document.getElementById('jamAkhir').value,
                    jumlah_hadir: document.getElementById('jumlahHadir').value,
                    jumlah_tidak_hadir: document.getElementById('jumlahTidakHadir').value,
                    nama_tidak_hadir: document.getElementById('namaTidakHadir').value,
                    kegiatan: document.getElementById('kegiatan').value,
                    materi: document.getElementById('materi').value,
                    keterangan: document.getElementById('keterangan').value
                };
                
                const savedJurnal = await saveJurnal(jurnal);
                jurnalData.push(savedJurnal);
                
                showAlert('Data berhasil disimpan!', 'success');
                document.getElementById('formJurnal').reset();
            } catch (error) {
                showAlert('Gagal menyimpan jurnal!', 'error');
            }
        });

        // Rekap Functions
        function rekapHarian() {
            const kelas = document.getElementById('filterKelasRekap').value;
            const tanggal = document.getElementById('filterTanggal').value;
            
            if (!tanggal) {
                showAlert('Pilih tanggal terlebih dahulu!', 'error');
                return;
            }
            
            let siswaFilter = siswaData;
            if (kelas) {
                siswaFilter = siswaData.filter(s => s.kelas === kelas);
            }
            
            const presensiHariIni = presensiData.filter(p => p.tanggal === tanggal);
            
            let html = `
                <h3 class="text-lg font-semibold mb-4">Rekap Harian - ${tanggal}</h3>
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-2 text-left">No</th>
                                <th class="px-4 py-2 text-left">Nama</th>
                                <th class="px-4 py-2 text-left">Kelas</th>
                                <th class="px-4 py-2 text-left">Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            siswaFilter.forEach((siswa, index) => {
                const presensi = presensiHariIni.find(p => p.siswa_id === siswa.id);
                const status = presensi ? presensi.status : 'Alpha';
                const statusColor = status === 'Hadir' ? 'text-green-600 font-semibold' : 'text-red-600 font-semibold';
                
                html += `
                    <tr class="border-b">
                        <td class="px-4 py-2">${index + 1}</td>
                        <td class="px-4 py-2">${siswa.nama}</td>
                        <td class="px-4 py-2">${siswa.kelas}</td>
                        <td class="px-4 py-2 ${statusColor}">${status}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('hasilRekap').innerHTML = html;
        }

        function rekapSemuaWaktu() {
            const kelas = document.getElementById('filterKelasRekap').value;
            
            let siswaFilter = siswaData;
            if (kelas) {
                siswaFilter = siswaData.filter(s => s.kelas === kelas);
            }
            
            let html = `
                <h3 class="text-lg font-semibold mb-4">Rekap Semua Waktu</h3>
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-2 text-left">No</th>
                                <th class="px-4 py-2 text-left">Nama</th>
                                <th class="px-4 py-2 text-left">Kelas</th>
                                <th class="px-4 py-2 text-left">Hadir</th>
                                <th class="px-4 py-2 text-left">Sakit</th>
                                <th class="px-4 py-2 text-left">Ijin</th>
                                <th class="px-4 py-2 text-left">Alpha</th>
                                <th class="px-4 py-2 text-left">Dispen</th>
                                <th class="px-4 py-2 text-left">Persentase</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            siswaFilter.forEach((siswa, index) => {
                const presensiSiswa = presensiData.filter(p => p.siswa_id === siswa.id);
                
                const hadir = presensiSiswa.filter(p => p.status === 'Hadir').length;
                const sakit = presensiSiswa.filter(p => p.status === 'Sakit').length;
                const ijin = presensiSiswa.filter(p => p.status === 'Ijin').length;
                const alpha = presensiSiswa.filter(p => p.status === 'Alpha').length;
                const dispen = presensiSiswa.filter(p => p.status === 'Dispen').length;
                
                const total = presensiSiswa.length;
                const persentase = total > 0 ? (((hadir + dispen) / total) * 100).toFixed(1) : 0;
                
                html += `
                    <tr class="border-b">
                        <td class="px-4 py-2">${index + 1}</td>
                        <td class="px-4 py-2">${siswa.nama}</td>
                        <td class="px-4 py-2">${siswa.kelas}</td>
                        <td class="px-4 py-2 text-green-600">${hadir}</td>
                        <td class="px-4 py-2 text-yellow-600">${sakit}</td>
                        <td class="px-4 py-2 text-blue-600">${ijin}</td>
                        <td class="px-4 py-2 text-red-600">${alpha}</td>
                        <td class="px-4 py-2 text-purple-600">${dispen}</td>
                        <td class="px-4 py-2 font-semibold">${persentase}%</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('hasilRekap').innerHTML = html;
        }

       function loadJurnal() {
            const tanggal = document.getElementById('filterTanggalJurnal').value;
            const kelas = document.getElementById('filterKelasJurnal').value;
            const mapel = document.getElementById('filterMapelJurnal').value;
            
            let jurnalFilter = jurnalData;
            if (tanggal) {
                jurnalFilter = jurnalFilter.filter(j => j.tanggal === tanggal);
            }
            if (kelas) {
                jurnalFilter = jurnalFilter.filter(j => j.kelas === kelas);
            }
            if (mapel) {
                jurnalFilter = jurnalFilter.filter(j => j.mapel === mapel);
            }
            
            // Desktop Table
            const tbody = document.getElementById('daftarJurnal');
            tbody.innerHTML = '';
            
            // Mobile Cards
            const mobileContainer = document.getElementById('daftarJurnalMobile');
            mobileContainer.innerHTML = '';
            
            jurnalFilter.forEach((jurnal, index) => {
                // Desktop table row
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-2">${index + 1}</td>
                    <td class="px-4 py-2">${jurnal.mapel}</td>
                    <td class="px-4 py-2">${jurnal.kelas}</td>
                    <td class="px-4 py-2">${jurnal.tanggal}</td>
                    <td class="px-4 py-2">${jurnal.jam_awal}</td>
                    <td class="px-4 py-2">${jurnal.jam_akhir}</td>
                    <td class="px-4 py-2 text-green-600">${jurnal.jumlah_hadir}</td>
                    <td class="px-4 py-2 text-red-600">${jurnal.jumlah_tidak_hadir}</td>
                    <td class="px-4 py-2 text-sm">${jurnal.nama_tidak_hadir || '-'}</td>
                    <td class="px-4 py-2">${jurnal.kegiatan}</td>
                    <td class="px-4 py-2">${jurnal.materi || '-'}</td>
                    <td class="px-4 py-2">${jurnal.keterangan || '-'}</td>
                    <td class="px-4 py-2">
                        <button onclick="editJurnal(${jurnal.id})" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm mr-2">Edit</button>
                        <button onclick="hapusJurnal(${jurnal.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">Hapus</button>
                    </td>
                `;
                tbody.appendChild(row);
                
                // Mobile card
                const card = document.createElement('div');
                card.className = 'bg-gray-50 rounded-lg p-4 border';
                card.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <div class="text-sm font-medium text-gray-600">No</div>
                            <div class="flex gap-2">
                                <button onclick="editJurnal(${jurnal.id})" class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs">Edit</button>
                                <button onclick="hapusJurnal(${jurnal.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">Hapus</button>
                            </div>
                        </div>
                        <div class="text-lg font-semibold text-blue-600">${index + 1}</div>
                        
                        <div class="text-sm font-medium text-gray-600">Mata Pelajaran:</div>
                        <div class="text-base font-medium">${jurnal.mapel}</div>
                        
                        <div class="text-sm font-medium text-gray-600">Kelas:</div>
                        <div class="text-base font-medium">${jurnal.kelas}</div>
                        
                        <div class="text-sm font-medium text-gray-600">Tanggal:</div>
                        <div class="text-base">${jurnal.tanggal}</div>
                        
                        <div class="text-sm font-medium text-gray-600">Jam Awal:</div>
                        <div class="text-base">${jurnal.jam_awal}</div>
                        
                        <div class="text-sm font-medium text-gray-600">Jam Akhir:</div>
                        <div class="text-base">${jurnal.jam_akhir}</div>
                        
                        <div class="text-sm font-medium text-gray-600">Hadir:</div>
                        <div class="text-base text-green-600 font-semibold">${jurnal.jumlah_hadir}</div>
                        
                        <div class="text-sm font-medium text-gray-600">Tidak Hadir:</div>
                        <div class="text-base text-red-600 font-semibold">${jurnal.jumlah_tidak_hadir}</div>
                        
                        <div class="text-sm font-medium text-gray-600">Nama Siswa Tidak Hadir:</div>
                        <div class="text-base">${jurnal.nama_tidak_hadir || '-'}</div>
                        
                        <div class="text-sm font-medium text-gray-600">Kegiatan:</div>
                        <div class="text-base">${jurnal.kegiatan}</div>
                        
                        <div class="text-sm font-medium text-gray-600">Materi:</div>
                        <div class="text-base">${jurnal.materi || '-'}</div>
                        
                        <div class="text-sm font-medium text-gray-600">Keterangan:</div>
                        <div class="text-base">${jurnal.keterangan || '-'}</div>
                    </div>
                `;
                mobileContainer.appendChild(card);
            });
        }

        function hapusJurnal(id) {
            showConfirmModal('Apakah Anda yakin ingin menghapus jurnal ini?', async () => {
                try {
                    await deleteJurnal(id);
                    jurnalData = jurnalData.filter(j => j.id !== id);
                    showAlert('Data berhasil dihapus!', 'success');
                    loadJurnal();
                } catch (error) {
                    showAlert('Gagal menghapus jurnal!', 'error');
                }
            });
        }

        // Modal Functions
        function showConfirmModal(message, callback) {
            document.getElementById('pesanKonfirmasi').textContent = message;
            document.getElementById('modalKonfirmasi').classList.remove('hidden');
            document.getElementById('btnKonfirmasi').onclick = () => {
                callback();
                closeModal();
            };
        }

        function editJurnal(id) {
            const jurnal = jurnalData.find(j => j.id === id);
            if (jurnal) {
                document.getElementById('editJurnalId').value = jurnal.id;
                document.getElementById('editNamaMapel').value = jurnal.mapel;
                document.getElementById('editKelasJurnal').value = jurnal.kelas;
                document.getElementById('editJamAwal').value = jurnal.jam_awal;
                document.getElementById('editJamAkhir').value = jurnal.jam_akhir;
                document.getElementById('editJumlahHadir').value = jurnal.jumlah_hadir;
                document.getElementById('editJumlahTidakHadir').value = jurnal.jumlah_tidak_hadir;
                document.getElementById('editNamaTidakHadir').value = jurnal.nama_tidak_hadir;
                document.getElementById('editKegiatan').value = jurnal.kegiatan;
                document.getElementById('editMateri').value = jurnal.materi;
                document.getElementById('editKeterangan').value = jurnal.keterangan;
                document.getElementById('modalEditJurnal').classList.remove('hidden');
            }
        }

        document.getElementById('formEditJurnal').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = parseInt(document.getElementById('editJurnalId').value);
            const mapel = document.getElementById('editNamaMapel').value;
            const kelas = document.getElementById('editKelasJurnal').value;
            const jamAwal = document.getElementById('editJamAwal').value;
            const jamAkhir = document.getElementById('editJamAkhir').value;
            const jumlahHadir = document.getElementById('editJumlahHadir').value;
            const jumlahTidakHadir = document.getElementById('editJumlahTidakHadir').value;
            const namaTidakHadir = document.getElementById('editNamaTidakHadir').value;
            const kegiatan = document.getElementById('editKegiatan').value;
            const materi = document.getElementById('editMateri').value;
            const keterangan = document.getElementById('editKeterangan').value;
            
            try {
                const jurnalUpdate = {
                    mapel: mapel,
                    kelas: kelas,
                    jam_awal: jamAwal,
                    jam_akhir: jamAkhir,
                    jumlah_hadir: jumlahHadir,
                    jumlah_tidak_hadir: jumlahTidakHadir,
                    nama_tidak_hadir: namaTidakHadir,
                    kegiatan: kegiatan,
                    materi: materi,
                    keterangan: keterangan
                };
                
                await updateJurnal(id, jurnalUpdate);
                
                const index = jurnalData.findIndex(j => j.id === id);
                if (index !== -1) {
                    Object.assign(jurnalData[index], jurnalUpdate);
                }
                
                showAlert('Data berhasil diperbarui!', 'success');
                closeModal();
                loadJurnal();
            } catch (error) {
                showAlert('Gagal memperbarui jurnal!', 'error');
            }
        });

        function closeModal() {
            document.getElementById('modalKonfirmasi').classList.add('hidden');
            document.getElementById('modalEditSiswa').classList.add('hidden');
            document.getElementById('modalEditJurnal').classList.add('hidden');
        }

        // PDF Download Function
        function downloadJurnalPDF() {
            const tanggal = document.getElementById('filterTanggalJurnal').value;
            const kelas = document.getElementById('filterKelasJurnal').value;
            const mapel = document.getElementById('filterMapelJurnal').value;
            
            let jurnalFilter = jurnalData;
            if (tanggal) {
                jurnalFilter = jurnalFilter.filter(j => j.tanggal === tanggal);
            }
            if (kelas) {
                jurnalFilter = jurnalFilter.filter(j => j.kelas === kelas);
            }
            if (mapel) {
                jurnalFilter = jurnalFilter.filter(j => j.mapel === mapel);
            }
            
            if (jurnalFilter.length === 0) {
                showAlert('Tidak ada data jurnal untuk diunduh!', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Group jurnal by date
            const jurnalByDate = {};
            jurnalFilter.forEach(jurnal => {
                if (!jurnalByDate[jurnal.tanggal]) {
                    jurnalByDate[jurnal.tanggal] = [];
                }
                jurnalByDate[jurnal.tanggal].push(jurnal);
            });
            
            let yPosition = 20;
            
            // Title
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('REKAP JURNAL MENGAJAR', 105, yPosition, { align: 'center' });
            yPosition += 15;
            
            // Process each date
            Object.keys(jurnalByDate).sort().forEach((tanggalKey, dateIndex) => {
                if (dateIndex > 0) {
                    // Add new page for each date after the first
                    doc.addPage();
                    yPosition = 20;
                }
                
                const jurnalTanggal = jurnalByDate[tanggalKey];
                
                // Date header
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`Tanggal: ${tanggalKey}`, 20, yPosition);
                yPosition += 10;
                
                // Prepare table data
                const tableData = jurnalTanggal.map((jurnal, index) => [
                    index + 1,
                    jurnal.mapel,
                    jurnal.kelas,
                    jurnal.tanggal,
                    jurnal.jam_awal,
                    jurnal.jam_akhir,
                    jurnal.jumlah_hadir,
                    jurnal.jumlah_tidak_hadir,
                    jurnal.nama_tidak_hadir || '-',
                    jurnal.kegiatan,
                    jurnal.materi || '-',
                    jurnal.keterangan || '-'
                ]);
                
                // Create table
                doc.autoTable({
                    head: [['No', 'Mata Pelajaran', 'Kelas', 'Tanggal', 'Jam Awal', 'Jam Akhir', 'Hadir', 'Tidak Hadir', 'Nama Siswa Tidak Hadir', 'Kegiatan', 'Materi', 'Keterangan']],
                    body: tableData,
                    startY: yPosition,
                    styles: {
                        fontSize: 8,
                        cellPadding: 2
                    },
                    headStyles: {
                        fillColor: [66, 139, 202],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    columnStyles: {
                        0: { cellWidth: 8 },  // No
                        1: { cellWidth: 20 }, // Mata Pelajaran
                        2: { cellWidth: 12 }, // Kelas
                        3: { cellWidth: 18 }, // Tanggal
                        4: { cellWidth: 12 }, // Jam Awal
                        5: { cellWidth: 12 }, // Jam Akhir
                        6: { cellWidth: 10 }, // Hadir
                        7: { cellWidth: 12 }, // Tidak Hadir
                        8: { cellWidth: 30 }, // Nama Siswa Tidak Hadir
                        9: { cellWidth: 25 }, // Kegiatan
                        10: { cellWidth: 25 }, // Materi
                        11: { cellWidth: 20 }  // Keterangan
                    },
                    margin: { left: 10, right: 10 }
                });
            });
            
            // Generate filename
            const today = new Date().toISOString().split('T')[0];
            let filename = `Rekap_Jurnal_${today}`;
            if (tanggal) filename += `_${tanggal}`;
            if (kelas) filename += `_${kelas}`;
            if (mapel) filename += `_${mapel.replace(/\s+/g, '_')}`;
            filename += '.pdf';
            
            // Save PDF
            doc.save(filename);
            showAlert('PDF berhasil diunduh!', 'success');
        }
    </script>
</html>
